import sqlalchemy
from sqlalchemy import create_engine, or_
from sqlalchemy.orm import sessionmaker
from datalabs.etl.cpt.dbmodel import PLACode, PLAShortDescriptor, PLAMediumDescriptor, PLALongDescriptor, Manufacturer, \
    ManufacturerPLACodeMapping, Lab, LabPLACodeMapping, Release
from datalabs.access.database import Database


def lambda_handler(event, context):
    engine = create_engine(Database.url)
    Session = sessionmaker(bind=engine)
    session = Session()

    status_code, response = query_event(event.get('code', None), session)
    return {'statusCode': status_code, 'body': response}


def query_event(event, session):
    if event is None:
        return 400, {'code': 'not given'}
    else:
        query = query_for_code(event, session)
        return get_response_data_from_query(query, event.get('length', None))


def query_for_code(event, session):
    query = session.query(PLACode, PLALongDescriptor, PLAShortDescriptor, PLAMediumDescriptor).join(PLAShortDescriptor,
                                                                                                    PLALongDescriptor,
                                                                                                    PLAMediumDescriptor)\
        .filter(PLACode.code == event)
    return query


def get_response_data_from_query(query, lengths):
    if lengths is not None:
        return get_filtered_length_response(query, lengths)
    else:
        return get_content_from_query(query)


def get_filtered_length_response(query, lengths):
    length_dict = {"long": "PLALongDescriptor", "medium": "PLAMediumDescriptor", "short": "PLAShortDescriptor"}
    result = []
    query_exist = query_exists(query)

    if query_exist:
        for row in query.all():
            result.append({
                "code": row.Code.code,
                lengths + '_descriptor': getattr(row, length_dict.get(lengths)).descriptor,
                'code_status': row.PLACode.status,
                'effective_date': row.Release.effective_date,
                'lab_name': row.Lab.name,
                'manufacturer_name': row.Manufacturer.name,
                'publish_date': row.Release.publish_date,
                'test_name': row.PLACode.test_name
            })
        return 200, result
    else:
        return 400, {"invalid": "code"}


def get_content_from_query(query):
    result = []
    query_exist = query_exists(query)

    if query_exist:
        for row in query.all():
            record = {
                'code': row.PLACode.code,
                'long_descriptor': row.PLALongDescriptor.descriptor,
                'medium_descriptor': row.PLAMediumDescriptor.descriptor,
                'short_descriptor': row.PLAShortDescriptor.descriptor,
                'code_status': row.PLACode.status,
                'effective_date': row.Release.effective_date,
                'lab_name': row.Lab.name,
                'manufacturer_name': row.Manufacturer.name,
                'publish_date': row.Release.publish_date,
                'test_name': row.PLACode.test_name
            }

            result.append(record)

        return 200, result
    else:
        return 400, {"invalid": "code"}


def query_exists(query):
    if query.count() == 0:
        return False
    else:
        return True
