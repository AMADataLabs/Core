image:
  name: 644454719059.dkr.ecr.us-east-1.amazonaws.com/datalabs-bitbucket-pipelines:1.3.0
  aws:
    access-key: $AWS_ACCESS_KEY_ID_SANDBOX
    secret-key: $AWS_SECRET_ACCESS_KEY_SANDBOX

options:
  docker: true

pipelines:
    branches:
        master:
        - step:
            name: Build
            caches:
                - build-dependencies
            script:
            - bash Script/bitbucket-pipelines-build.sh
    tags:
        'datalabs-*_*.*.*':
        - step:
            name: Build Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - source Deploy/Master/release-info.sh $BITBUCKET_TAG
            - >-
                bash Deploy/Master/deploy-package
                --project ${PROJECT}
                --version ${RELEASE_VERSION}
    custom:
        ##############################################################
        # global targets
        ##############################################################

        Test:
        - step:
            name: Unit and Lint Tests
            caches:
                - test-dependencies
            script:
                - bash Script/bitbucket-pipelines-test.sh


        ##############################################################
        # master branch targets
        ##############################################################

        AMC:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project AMC --environment sbx
        - step:
            name: Update ETL Bundle
            caches:
                - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - >-
                bash Deploy/Master/deploy-lambda-function
                --environment sbx
                --project AMC
                --bundle Masterfile/AMC.zip
                --runtime Python
                --jdbc-driver Informix
                --use-package
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project AMC
                    --bundle Masterfile/AMC.zip
                    --runtime Python
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project AMC
                    --bundle Masterfile/AMC.zip
                    --runtime Python
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project AMC
                    --bundle Masterfile/AMC.zip
                    --runtime Python
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project AMC
                    --bundle Masterfile/AMC.zip
                    --runtime Python
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project AMC
                    --bundle Masterfile/AMC.zip
                    --runtime Python
                    --jdbc-driver Informix
                    --use-package
        # - step:
        #     name: Update Lambda Functions
        #     script:
        #     - export ENABLE_FEATURE_DEV=True
        #     - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_SANDBOX
        #     - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_SANDBOX
        #     - export AWS_DEFAULT_REGION='us-east-1'
        #     - export ENVIRONMENT=sbx
        #     - bash Deploy/Master/update-functions -e sbx -s OneView -p Masterfile AMC=AMC.zip

        ContactID:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project ContactID --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project ContactID
                    --bundle CustomerIntelligence/ContactID.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project ContactID
                    --bundle CustomerIntelligence/ContactID.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project ContactID
                    --bundle CustomerIntelligence/ContactID.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project ContactID
                    --bundle CustomerIntelligence/ContactID.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project ContactID
                    --bundle CustomerIntelligence/ContactID.zip
                    --runtime Python
                    --use-package
   #     - parallel:
        - step:
            name: Update sandbox Lambda Functions
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/update-functions -e sbx -s DataLake -p CustomerIntelligence ContactID=ContactID.zip

   #         - step:
   #             name: Update development Lambda Functions
   #             script:
   #             - >-
   #                 bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
   #                 -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
   #             - >-
   #                 bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s DataLake
   #                 -p CustomerIntelligence ContactID=ContactID.zip
   #         - step:
   #             name: Update test Lambda Functions
   #             script:
   #             - >-
   #                 bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
   #                 -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
   #             - >-
   #                 bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s DataLake
   #                 -p CustomerIntelligence ContactID=ContactID.zip
   #         - step:
   #             name: Update production Lambda Functions
   #             script:
   #             - >-
   #                 bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
   #                 -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
   #             - >-
   #                 bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s DataLake
   #                 -p CustomerIntelligence ContactID=ContactID.zip

        CPT-API-ETL:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project CPT/API/ETL --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project CPT/API/ETL
                    --bundle CPT/API/ETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project CPT/API/ETL
                    --bundle CPT/API/ETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project CPT/API/ETL
                    --bundle CPT/API/ETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project CPT/API/ETL
                    --bundle CPT/API/ETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project CPT/API/ETL
                    --bundle CPT/API/ETL.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Update sandbox Lambda Functions
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s CPT-API -p CPT/API ETL=ETL.zip
            - step:
                name: Update development Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s CPT-API -p CPT/API
                    ETL=ETL.zip
            - step:
                name: Update test Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s CPT-API -p CPT/API
                    ETL=ETL.zip
            - step:
                name: Update production Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s CPT-API -p CPT/API
                    ETL=ETL.zip

        CPT-API-Endpoint:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project CPT/API/Endpoint --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project CPT/API/Endpoint
                    --bundle CPT/API/Endpoint.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project CPT/API/Endpoint
                    --bundle CPT/API/Endpoint.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project CPT/API/Endpoint
                    --bundle CPT/API/Endpoint.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project CPT/API/Endpoint
                    --bundle CPT/API/Endpoint.zipp
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project CPT/API/Endpoint
                    --bundle CPT/API/Endpoint.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Update sandbox Lambda Functions
                script:
                    - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    - >-
                        bash Deploy/Master/update-functions -e sbx -s CPT-API -p CPT/API
                        Authorizer=Endpoint.zip
                        Endpoint=Endpoint.zip
                        BulkAuthorizer=Endpoint.zip
                        BulkEndpoint=Endpoint.zip
            - step:
                name: Update development Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s CPT-API -p CPT/API
                    Authorizer=Endpoint.zip
                    Endpoint=Endpoint.zip
                    BulkAuthorizer=Endpoint.zip
                    BulkEndpoint=Endpoint.zip
            - step:
                name: Update test Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s CPT-API -p CPT/API
                    Authorizer=Endpoint.zip
                    Endpoint=Endpoint.zip
                    BulkAuthorizer=Endpoint.zip
                    BulkEndpoint=Endpoint.zip
            - step:
                name: Update production Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s CPT-API -p CPT/API
                    Authorizer=Endpoint.zip
                    Endpoint=Endpoint.zip
                    BulkAuthorizer=Endpoint.zip
                    BulkEndpoint=Endpoint.zip

        CPT-Files-Watermark:
        - step:
            name: Update Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project CPT/Files/Watermark --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project CPT/Files/Watermark
                    --bundle CPT/Files/Watermark.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project CPT/Files/Watermark
                    --bundle CPT/Files/Watermark.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project CPT/Files/Watermark
                    --bundle CPT/Files/Watermark.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project CPT/Files/Watermark
                    --bundle CPT/Files/Watermark.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project CPT/Files/Watermark
                    --bundle CPT/Files/Watermark.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Update sandbox Lambda Functions
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s CPT-API -p CPT/Files WatermarkDAG=Watermark.zip
            - step:
                name: Update development Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s CPT-API -p CPT/Files
                    WatermarkDAG=Watermark.zip
            # - step:
            #     name: Update test Lambda Functions
            #     script:
            #     - >-
            #         bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            #         -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
            #     - >-
            #         bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s CPT-API -p CPT/Files
            #         WatermarkDAG=Watermark.zip
            # - step:
            #     name: Update production Lambda Functions
            #     script:
            #     - >-
            #         bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            #         -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
            #     - >-
            #         bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s CPT-API -p CPT/Files
            #         WatermarkDAG=Watermark.zip

        DBL:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project DBL --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project DBL
                    --bundle Masterfile/DBLReport.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project DBL
                    --bundle Masterfile/DBLReport.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project DBL
                    --bundle Masterfile/DBLReport.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project DBL
                    --bundle Masterfile/DBLReport.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project DBL
                    --bundle Masterfile/DBLReport.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Update sandbox Lambda Functions
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s OneView -p  Masterfile DBLReport=DBLReport.zip
            - step:
                name: Update development Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s OneView -p Masterfile DBLReport=DBLReport.zip
            - step:
                name: Update test Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s OneView -p Masterfile DBLReport=DBLReport.zip
            - step:
                name: Update production Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s OneView -p Masterfile DBLReport=DBLReport.zip

        HelloWorldJava:
        - parallel:
            - step:
                name: Update DAG Bundle
                caches:
                - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project HelloWorldJava/DAG
                    --bundle HelloWorldJava/DAG.zip
                    --runtime Python
            - step:
                name: Update Task Bundle
                caches:
                - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project HelloWorldJava/Task
                    --bundle HelloWorldJava/Task.zip
                    --runtime Java

                # Create the Docker image
                - export VERSION=`cat Build/HelloWorldJava/Task/VERSION`
                - cp Bundle/target/hello_world_java-${VERSION}.jar ./hello_world_java.jar
                - docker build -t hello_world_java-sbx -f Build/HelloWorldJava/Task/Dockerfile ./

                # Push the Docker image to ECR
                - export VERSION=`cat Build/HelloWorldJava/Task/VERSION`
                - pipe: atlassian/aws-ecr-push-image:1.5.0
                  variables:
                    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID_SANDBOX
                    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY_SANDBOX
                    AWS_DEFAULT_REGION: 'us-east-1'
                    IMAGE_NAME: 'hello_world_java-sbx'
                    TAGS: '$VERSION latest'
        - step:
            name: Update Lambda Functions
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - >-
                bash Deploy/Master/update-functions -e sbx -s DataLake -p HelloWorldJava
                HelloWorldJavaDAG=DAG.zip
                HelloWorldJavaTask=Task.jar

        HelloWorldVault:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project HelloWorldVault --environment sbx
        - parallel:
            - step:
                name: Update Sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project HelloWorldVault
                    --bundle HelloWorldVault.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update Development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project HelloWorldVault
                    --bundle HelloWorldVault.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project HelloWorldVault
                    --bundle HelloWorldVault.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project HelloWorldVault
                    --bundle HelloWorldVault.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project HelloWorldVault
                    --bundle HelloWorldVault.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Update Sandbox Lambda Function
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s DataLake HelloWorldVault=HelloWorldVault.zip
            - step:
                name: Update Development Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s DataLake
                    HelloWorldVault=HelloWorldVault.zip
            - step:
                name: Update test Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s DataLake
                    HelloWorldVault=HelloWorldVault.zip
            - step:
                name: Update production Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s DataLake
                    HelloWorldVault=HelloWorldVault.zip
        OneView-ETL:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project OneView/ETL --environment sbx
        - parallel:
            - step:
                name: Update Sandbox Lambda Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project OneView/ETL
                    --bundle OneView/ETL.zip
                    --runtime Python
                    --jdbc-driver DB2
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update Development Lambda Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project OneView/ETL
                    --bundle OneView/ETL.zip
                    --runtime Python
                    --jdbc-driver DB2
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update Test Lambda Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project OneView/ETL
                    --bundle OneView/ETL.zip
                    --runtime Python
                    --jdbc-driver DB2
                    --jdbc-driver Informix
                    --use-package
            - step:
                name: Update Production Lambda Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project OneView/ETL
                    --bundle OneView/ETL.zip
                    --runtime Python
                    --jdbc-driver DB2
                    --jdbc-driver Informix
                    --use-package
        - parallel:
            - step:
                name: Update Sandbox Lambda Function
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s OneView -p OneView ETL=ETL.zip
            - step:
                name: Update Development Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s OneView -p OneView
                    ETL=ETL.zip
            - step:
                name: Update Test Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s OneView -p OneView
                    ETL=ETL.zip
            - step:
                name: Update Production Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s OneView -p OneView
                    ETL=ETL.zip

        OneView-Reindex:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project OneView/ETL/Reindex --environment sbx
        - parallel:
            - step:
                name: Update Development Batch Job Image
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -N ecr -I $AWS_ACCESS_KEY_ID_SHARED -S $AWS_SECRET_ACCESS_KEY_SHARED
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-container-image
                    --environment dev
                    --project OneView/ETL/Reindex
                    --runtime Python
                    --repo oneview-dev
            - step:
                name: Update Test Batch Job Image
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -N ecr -I $AWS_ACCESS_KEY_ID_SHARED -S $AWS_SECRET_ACCESS_KEY_SHARED
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-container-image
                    --environment tst
                    --project OneView/ETL/Reindex
                    --runtime Python
                    --repo oneview-tst
            - step:
                name: Update Production Batch Job Image
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -N ecr -I $AWS_ACCESS_KEY_ID_SHARED -S $AWS_SECRET_ACCESS_KEY_SHARED
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-container-image
                    --environment prd
                    --project OneView/ETL/Reindex
                    --runtime Python
                    --repo oneview-prd

        OneView-API:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project OneView/API --environment sbx
        - parallel:
            - step:
                name: Update Sandbox Lambda Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project OneView/API
                    --bundle OneView/API.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update Development Lambda Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project OneView/API
                    --bundle OneView/API.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update Test Lambda Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project OneView/API
                    --bundle OneView/API.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update Production Lambda Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project OneView/API
                    --bundle OneView/API.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Reload Sandbox Lambda Functions
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s OneView -p OneView API=API.zip
            - step:
                name: Reload Development Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s OneView -p OneView
                    API=API.zip
            - step:
                name: Reload Test Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s OneView -p OneView
                    API=API.zip
            - step:
                name: Reload Production Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s OneView -p OneView
                    API=API.zip

        Organizations:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project CPT/Organizations --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project CPT/Organizations
                    --bundle IntelligentPlatform/OrganizationsETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project CPT/Organizations
                    --bundle IntelligentPlatform/OrganizationsETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project CPT/Organizations
                    --bundle IntelligentPlatform/OrganizationsETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project CPT/Organizations
                    --bundle IntelligentPlatform/OrganizationsETL.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project CPT/Organizations
                    --bundle IntelligentPlatform/OrganizationsETL.zip
                    --runtime Python
                    --use-package
        - parallel:
            - step:
                name: Update sandbox Lambda Functions
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s AIP
                  -p IntelligentPlatform OrganizationsETL=OrganizationsETL.zip
            - step:
                name: Update development Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s AIP
                    -p IntelligentPlatform OrganizationsETL=OrganizationsETL.zip
            - step:
                name: Update test Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s AIP
                    -p IntelligentPlatform OrganizationsETL=OrganizationsETL.zip
            - step:
                name: Update production Lambda Functions
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s AIP
                    -p IntelligentPlatform OrganizationsETL=OrganizationsETL.zip

        Scheduler:
        - step:
            name: Create Development Component Package
            caches:
            - environment-master
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - bash Deploy/Master/deploy-python-package --project Scheduler --environment sbx
        - parallel:
            - step:
                name: Update sandbox Bundle
                caches:
                    - environment-master
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - >-
                    bash Deploy/Master/deploy-lambda-function
                    --environment sbx
                    --project Scheduler
                    --bundle Scheduler.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update development Bundle
                caches:
                    - environment-dev
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment dev
                    --project Scheduler
                    --bundle Scheduler.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update test Bundle
                caches:
                    - environment-test
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment tst
                    --project Scheduler
                    --bundle Scheduler.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update staging Bundle
                caches:
                    - environment-stage
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e itg -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment itg
                    --project Scheduler
                    --bundle Scheduler.zip
                    --runtime Python
                    --use-package
            - step:
                name: Update production Bundle
                caches:
                    - environment-prod
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/deploy-lambda-function
                    --environment prd
                    --project Scheduler
                    --bundle Scheduler.zip
                    --runtime Python
                    --use-package
        - step:
            name: Update Lambda Functions
            script:
            - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
            - >-
                bash Deploy/Master/update-functions -e sbx -s DataLake
                Scheduler=Scheduler.zip
                DAGProcessor=Scheduler.zip
                TaskProcessor=Scheduler.zip
        parallel:
            - step:
                name: Update Sandbox Lambda Function
                script:
                - bash Deploy/Master/setup-aws-cli -e sbx -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                - bash Deploy/Master/update-functions -e sbx -s Scheduler -p OneView ETL=ETL.zip
            - step:
                name: Update Development Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e dev -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e dev -s DataLake
                    Scheduler=Scheduler.zip
                    DAGProcessor=Scheduler.zip
                    TaskProcessor=Scheduler.zip
            - step:
                name: Update Test Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e tst -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e tst -s DataLake
                    Scheduler=Scheduler.zip
                    DAGProcessor=Scheduler.zip
                    TaskProcessor=Scheduler.zip
            - step:
                name: Update Production Lambda Function
                script:
                - >-
                    bash Deploy/Master/setup-aws-cli -e prd -i $AWS_ACCESS_KEY_ID_SANDBOX -s $AWS_SECRET_ACCESS_KEY_SANDBOX
                    -I $AWS_ACCESS_KEY_ID_APIGW -S $AWS_SECRET_ACCESS_KEY_APIGW
                - >-
                    bash --rcfile assume_role.rc -i Deploy/Master/update-functions -e prd -s DataLake
                    Scheduler=Scheduler.zip
                    DAGProcessor=Scheduler.zip
                    TaskProcessor=Scheduler.z


definitions:
  caches:
    build-dependencies: Environment
    test-dependencies: Environment

    environment-master: Environment
    environment-dev: Environment
    environment-test: Environment
    environment-stage: Environment
    environment-prod: Environment
